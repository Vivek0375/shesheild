<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Incident Dashboard</title>
    <style>
        #map {
            height: 600px;
            width: 100%;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
<h2>Live Incident Dashboard</h2>

<div id="map"></div>

<table>
    <thead>
    <tr>
        <th>ID</th>
        <th>User ID</th>
        <th>Type</th>
        <th>Description</th>
        <th>Latitude</th>
        <th>Longitude</th>
        <th>Created At</th>
    </tr>
    </thead>
    <tbody id="incidentTable">
    <tr th:each="inc : ${incidents}">
        <td th:text="${inc.id}">1</td>
        <td th:text="${inc.userId}">123</td>
        <td th:text="${inc.type}">SOS</td>
        <td th:text="${inc.description}">Help!</td>
        <td th:text="${inc.latitude}">28.61</td>
        <td th:text="${inc.longitude}">77.23</td>
        <td th:text="${inc.createdAt}">2025-10-04T21:00</td>
    </tr>
    </tbody>
</table>

<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script>
<script>
    let map;
    let markers = [];

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: 20.5937, lng: 78.9629}, // center of India
            zoom: 5
        });

        addMarkers();
    }

    function addMarkers() {
        // clear old markers
        markers.forEach(marker => marker.setMap(null));
        markers = [];

        const rows = document.querySelectorAll('#incidentTable tr');
        rows.forEach(row => {
            const lat = parseFloat(row.cells[4].textContent);
            const lng = parseFloat(row.cells[5].textContent);
            const type = row.cells[2].textContent;
            const desc = row.cells[3].textContent;

            const marker = new google.maps.Marker({
                position: {lat: lat, lng: lng},
                map: map,
                title: type + ": " + desc
            });

            markers.push(marker);
        });
    }

    // Auto-refresh every 10 seconds
    setInterval(() => {
        fetch('/api/incidents')
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('incidentTable');
                tbody.innerHTML = '';
                data.forEach(inc => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${inc.id}</td>
                        <td>${inc.userId}</td>
                        <td>${inc.type}</td>
                        <td>${inc.description}</td>
                        <td>${inc.latitude}</td>
                        <td>${inc.longitude}</td>
                        <td>${inc.createdAt}</td>
                    `;
                    tbody.appendChild(row);
                });
                addMarkers(); // update map markers
            });
    }, 10000);

    window.onload = initMap;
</script>
</body>
</html>
